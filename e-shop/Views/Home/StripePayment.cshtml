@{
    ViewData["Title"] = "Stripe Payment";
    Layout = "~/Views/Shared/_Layoutforallpage.cshtml";
    var returnUrl = Url.Action("ConfirmStripePayment", "Home", null, Context.Request.Scheme);
}

<script src="https://js.stripe.com/v3/"></script>

<div class="container mt-5 mb-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow rounded-4 border-0">
                <div class="card-body p-4">
                    <h2 class="text-center mb-4 text-primary fw-bold">Pay with Stripe</h2>

                    <p class="text-center mb-4 fs-5">
                        <strong>Total Amount:</strong> <span class="text-success">₹@ViewBag.Amount</span>
                    </p>

                    <form id="payment-form">
                        <div id="card-element" class="form-control p-3 mb-3 shadow-sm rounded-3"></div>

                        <div id="card-errors" class="text-danger small mb-3"></div>

                        <button id="pay-button" class="btn btn-success w-100 py-2 fw-semibold shadow-sm">
                            Pay Now
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    const stripe = Stripe("@ViewBag.PublishableKey");
    const elements = stripe.elements();

    const cardElement = elements.create("card");
    cardElement.mount("#card-element");

    const form = document.getElementById("payment-form");

    form.addEventListener("submit", async (event) => {
        event.preventDefault();

        const { error, paymentIntent } = await stripe.confirmCardPayment("@ViewBag.ClientSecret", {
            payment_method: {
                card: cardElement
            },
            return_url: "@returnUrl"
        });

        if (error) {
            document.getElementById("card-errors").textContent = error.message;
        } else if (paymentIntent && paymentIntent.status === "succeeded") {
            // Redirect manually if payment succeeded without 3D Secure
            window.location.href = "@returnUrl?payment_intent=" + paymentIntent.id;
        }
    });
</script>
